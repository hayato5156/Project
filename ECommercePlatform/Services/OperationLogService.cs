using ECommercePlatform.Data;
using ECommercePlatform.Models;
using System.Security.Claims;

namespace ECommercePlatform.Services
{
    public class OperationLogService
    {
        private readonly ApplicationDbContext _context;
        private readonly IHttpContextAccessor _http;
        public OperationLogService(ApplicationDbContext context, IHttpContextAccessor http)
        {
            _context = context;
            _http = http;
        }
        public void Log(string controller, string action, string? targetId = null, string? description = null)
        {
            var username = _http.HttpContext?.User?.Identity?.Name;

            // 依據登入名稱找出對應的 Engineer 實體
            var engineer = _context.Engineers.FirstOrDefault(e => e.Username == username);

            var log = new OperationLog
            {
                Engineer = engineer, // 這裡是物件，而非string
                ActionTime = DateTime.UtcNow,
                Controller = controller,
                Action = action,
                TargetId = targetId,
                Description = description
            };
            _context.OperationLogs.Add(log);
            _context.SaveChanges();
        }
    }
}