<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>訂單管理 | 後台管理系統</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f4f6f8;
            padding: 2rem;
        }

        h1 {
            margin-bottom: 1rem;
        }

        .search-bar, .export-bar {
            margin-bottom: 1rem;
        }

            .search-bar input, .search-bar button, .export-bar button {
                padding: 0.4rem;
                margin-right: 0.5rem;
                font-size: 1rem;
            }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 0.75rem;
        }

        th {
            background-color: #eee;
        }

        .btn {
            padding: 0.3rem 0.7rem;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .details {
            margin-bottom: 2rem;
            background-color: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

            .details table {
                margin-top: 1rem;
            }

        select {
            padding: 0.3rem;
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <h1>訂單管理</h1>

    <div class="search-bar">
        <input type="text" id="search-user" placeholder="用戶帳號">
        <input type="date" id="search-from">
        <input type="date" id="search-to">
        <button onclick="loadOrders()">搜尋</button>
    </div>

    <div class="export-bar">
        <button class="btn" onclick="exportOrders('excel')">匯出 Excel</button>
        <button class="btn" onclick="exportOrders('pdf')">匯出 PDF</button>
    </div>

    <table id="ordersTable">
        <thead>
            <tr>
                <th>訂單編號</th>
                <th>用戶</th>
                <th>總金額</th>
                <th>狀態</th>
                <th>建立時間</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div id="orderDetails" class="details" style="display: none;">
        <h2>訂單明細</h2>
        <p><strong>用戶：</strong> <span id="detail-user"></span></p>
        <p><strong>寄送地址：</strong> <span id="detail-address"></span></p>
        <p><strong>付款方式：</strong> <span id="detail-payment"></span></p>
        <p>
            <strong>狀態：</strong>
            <select id="detail-status">
                <option value="Pending">待處理</option>
                <option value="Paid">已付款</option>
                <option value="Shipped">已出貨</option>
                <option value="Completed">已完成</option>
                <option value="Canceled">已取消</option>
            </select>
            <button class="btn" onclick="updateStatus()">更新狀態</button>
        </p>
        <p>
            <label><input type="checkbox" id="detail-payment-verified"> 付款已驗證</label>
            <button class="btn" onclick="updatePayment()">更新付款狀態</button>
        </p>
        <p>
            <label>標籤： <input type="text" id="detail-tags" style="width: 200px;"></label>
            <button class="btn" onclick="updateTags()">更新標籤</button>
        </p>
        <table>
            <thead>
                <tr><th>商品</th><th>數量</th><th>單價</th></tr>
            </thead>
            <tbody id="itemsTableBody"></tbody>
        </table>
    </div>

    <script>
        let currentOrderId = null;

        async function loadOrders() {
            const user = document.getElementById('search-user').value;
            const from = document.getElementById('search-from').value;
            const to = document.getElementById('search-to').value;

            const params = new URLSearchParams();
            if (user) params.append('user', user);
            if (from) params.append('from', from);
            if (to) params.append('to', to);

            const res = await fetch('/api/admin/orders?' + params.toString(), { credentials: 'include' });
            const data = await res.json();
            const tbody = document.querySelector('#ordersTable tbody');
            tbody.innerHTML = '';
            data.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
              <td>${order.id}</td>
              <td>${order.userName}</td>
              <td>$${order.totalAmount.toFixed(2)}</td>
              <td>${order.orderStatus}</td>
              <td>${order.orderDate.replace('T', ' ').slice(0, 19)}</td>
              <td><button class="btn" onclick="viewOrder(${order.id})">查看</button></td>
            `;
                tbody.appendChild(row);
            });
        }

        async function viewOrder(id) {
            currentOrderId = id;
            const res = await fetch(`/api/admin/orders/${id}`, { credentials: 'include' });
            const data = await res.json();

            document.getElementById('detail-user').textContent = `${data.user.username} (${data.user.email})`;
            document.getElementById('detail-address').textContent = data.shippingAddress || '-';
            document.getElementById('detail-payment').textContent = data.paymentMethod || '-';
            document.getElementById('detail-status').value = data.orderStatus;
            document.getElementById('detail-payment-verified').checked = data.paymentVerified;
            document.getElementById('detail-tags').value = data.tags || '';

            const tbody = document.getElementById('itemsTableBody');
            tbody.innerHTML = '';
            data.items.forEach(item => {
                tbody.innerHTML += `
              <tr>
                <td>${item.productName}</td>
                <td>${item.quantity}</td>
                <td>$${item.unitPrice.toFixed(2)}</td>
              </tr>
            `;
            });

            document.getElementById('orderDetails').style.display = 'block';
        }

        async function updateStatus() {
            const status = document.getElementById('detail-status').value;
            const res = await fetch(`/api/admin/orders/${currentOrderId}/status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(status)
            });
            if (res.ok) {
                alert('狀態已更新');
                loadOrders();
            } else {
                alert('更新失敗');
            }
        }

        async function updatePayment() {
            const verified = document.getElementById('detail-payment-verified').checked;
            const res = await fetch(`/api/admin/orders/${currentOrderId}/payment-verify`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(verified)
            });
            if (res.ok) {
                alert('付款狀態已更新');
                loadOrders();
            } else {
                alert('更新失敗');
            }
        }

        async function updateTags() {
            const tags = document.getElementById('detail-tags').value;
            const res = await fetch(`/api/admin/orders/${currentOrderId}/tags`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(tags)
            });
            if (res.ok) {
                alert('標籤已更新');
                loadOrders();
            } else {
                alert('更新失敗');
            }
        }

        function exportOrders(format) {
            const user = document.getElementById('search-user').value;
            const from = document.getElementById('search-from').value;
            const to = document.getElementById('search-to').value;

            const params = new URLSearchParams();
            if (user) params.append('user', user);
            if (from) params.append('from', from);
            if (to) params.append('to', to);
            params.append('format', format);

            window.open('/api/admin/orders/export?' + params.toString(), '_blank');
        }

        loadOrders();
    </script>
</body>
</html>
