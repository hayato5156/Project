@model ECommercePlatform.Controllers.ReviewListViewModel

@{
    ViewData["Title"] = "å•†å“è©•åƒ¹";
    var currentSort = ViewBag.Sort?.ToString() ?? "latest";
    var currentKeyword = ViewBag.Keyword?.ToString() ?? "";
    var currentScoreFilter = ViewBag.ScoreFilter?.ToString() ?? "";
    var productId = ViewBag.ProductId;
}

<div class="container">
    <h2 class="mb-4">ğŸ“‹ å•†å“è©•åƒ¹åˆ—è¡¨</h2>

    <!-- ç¯©é¸è¡¨å–® -->
    <div class="row mb-3">
        <div class="col-12">
            <form method="get" class="row g-3">
                @if (productId != null)
                {
                    <input type="hidden" name="productId" value="@productId" />
                }
                
                <!-- é—œéµå­—æœå°‹ -->
                <div class="col-md-4">
                    <label class="form-label">é—œéµå­—æœå°‹</label>
                    <div class="input-group">
                        <input type="text" name="keyword" class="form-control" placeholder="æœå°‹è©•åƒ¹å…§å®¹..." value="@currentKeyword" />
                        <button type="submit" class="btn btn-outline-secondary">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <!-- è©•åˆ†ç¯©é¸ -->
                <div class="col-md-3">
                    <label class="form-label">è©•åˆ†ç¯©é¸</label>
                    <select name="scoreFilter" class="form-select">
                        <option value="">å…¨éƒ¨è©•åˆ†</option>
                        @{
                            var scores = new Dictionary<string, string>
                            {
                                {"5", "5æ˜Ÿ â˜…â˜…â˜…â˜…â˜…"},
                                {"4", "4æ˜Ÿ â˜…â˜…â˜…â˜…â˜†"},
                                {"3", "3æ˜Ÿ â˜…â˜…â˜…â˜†â˜†"},
                                {"2", "2æ˜Ÿ â˜…â˜…â˜†â˜†â˜†"},
                                {"1", "1æ˜Ÿ â˜…â˜†â˜†â˜†â˜†"}
                            };
                        }
                        @foreach (var score in scores)
                        {
                            <option value="@score.Key" @(currentScoreFilter == score.Key ? "selected" : "")>@score.Value</option>
                        }
                    </select>
                </div>

                <!-- æ’åºæ–¹å¼ -->
                <div class="col-md-3">
                    <label class="form-label">æ’åºæ–¹å¼</label>
                    <select name="sort" class="form-select">
                        @{
                            var sortOptions = new Dictionary<string, string>
                            {
                                {"latest", "æœ€æ–°å„ªå…ˆ"},
                                {"oldest", "æœ€èˆŠå„ªå…ˆ"},
                                {"highscore", "é«˜åˆ†å„ªå…ˆ"},
                                {"lowscore", "ä½åˆ†å„ªå…ˆ"},
                                {"helpful", "æœ€æœ‰ç”¨"}
                            };
                        }
                        @foreach (var sortOption in sortOptions)
                        {
                            <option value="@sortOption.Key" @(currentSort == sortOption.Key ? "selected" : "")>@sortOption.Value</option>
                        }
                    </select>
                </div>

                <!-- æ¸…é™¤ç¯©é¸ -->
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <a href="@(productId != null ? $"/Review/Index?productId={productId}" : "/Review/Index")" 
                       class="btn btn-outline-secondary w-100">
                        <i class="fas fa-undo me-1"></i>æ¸…é™¤
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- çµ±è¨ˆè³‡è¨Š -->
    <div class="row mb-3">
        <div class="col-md-8">
            <p class="text-muted">
                ğŸ“ ç¸½ç•™è¨€æ•¸ï¼š<strong>@(Model?.TotalReviews ?? 0)</strong>
                @if (Model?.AverageScore > 0)
                {
                    <span class="ms-3">
                        | â­ å¹³å‡è©•åˆ†ï¼š<strong>@Model.AverageScore.ToString("0.0")</strong>
                        <span class="text-warning">
                            @for (int i = 1; i <= 5; i++)
                            {
                                @(i <= Math.Round(Model.AverageScore) ? "â˜…" : "â˜†")
                            }
                        </span>
                    </span>
                }
            </p>
        </div>
        @if (User.Identity?.IsAuthenticated == true)
        {
            <div class="col-md-4 text-end">
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addReviewModal">
                    âœï¸ æ–°å¢è©•åƒ¹
                </button>
            </div>
        }
        else
        {
            <div class="col-md-4 text-end">
                <a asp-controller="Account" asp-action="Login" class="btn btn-outline-primary">
                    ğŸ”‘ ç™»å…¥å¾Œè©•åƒ¹
                </a>
            </div>
        }
    </div>

    <!-- è©•åƒ¹åˆ—è¡¨ -->
    <div class="row" id="reviewsContainer">
        @if (Model?.Reviews != null && Model.Reviews.Any())
        {
            @foreach (var review in Model.Reviews)
            {
                <div class="col-md-6 mb-4">
                    <div class="card h-100 shadow-sm review-card">
                        @* ç½®é ‚æ¨™ç±¤ *@
                        @if (review.IsPinned)
                        {
                            <div class="position-absolute top-0 end-0">
                                <span class="badge bg-warning text-dark" style="margin: 8px;">
                                    <i class="fas fa-thumbtack me-1"></i>ç½®é ‚
                                </span>
                            </div>
                        }

                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <div>
                                <strong>@(review.UserName ?? review.User?.Username ?? "åŒ¿åç”¨æˆ¶")</strong>
                                <div class="small text-muted">@review.CreatedAt.ToString("yyyy-MM-dd HH:mm")</div>
                            </div>
                            <div class="text-end">
                                <div class="text-warning fs-5">
                                    @for (int s = 1; s <= 5; s++)
                                    {
                                        @(s <= review.Rating ? "â˜…" : "â˜†")
                                    }
                                </div>
                                <div class="small text-muted">@review.RatingText</div>
                            </div>
                        </div>

                        <div class="card-body">
                            <p class="card-text">@review.Content</p>
                            
                            @* è©•åƒ¹åœ–ç‰‡ *@
                            @if (review.HasImage)
                            {
                                <div class="mb-3">
                                    <img src="/reviews/image/@review.Id"
                                         class="img-fluid rounded shadow-sm" 
                                         alt="è©•åƒ¹åœ–ç‰‡" 
                                         style="max-height: 200px; cursor: pointer;"
                                         onclick="showImageModal('/reviews/image/@review.Id')" />
                                </div>
                            }

                            @* ç®¡ç†å“¡å›è¦† *@
                            @if (review.HasAdminReply)
                            {
                                <div class="admin-reply bg-info bg-opacity-10 p-3 rounded mt-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-user-shield text-info me-2"></i>
                                        <strong class="text-info">å®˜æ–¹å›è¦†</strong>
                                        <small class="text-muted ms-auto">@review.AdminReplyTime?.ToString("MM-dd HH:mm")</small>
                                    </div>
                                    <p class="mb-0 small">@review.AdminReply</p>
                                </div>
                            }
                        </div>

                        <div class="card-footer d-flex justify-content-between align-items-center">
                            <!-- æœ‰ç”¨æ€§æŠ•ç¥¨ -->
                            <div class="helpful-votes">
                                @if (User.Identity?.IsAuthenticated == true)
                                {
                                    <button class="btn btn-sm btn-outline-success me-2 vote-helpful" 
                                            data-review-id="@review.Id" data-helpful="true">
                                        <i class="fas fa-thumbs-up me-1"></i>@review.HelpfulCount
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary vote-helpful" 
                                            data-review-id="@review.Id" data-helpful="false">
                                        <i class="fas fa-thumbs-down me-1"></i>@review.UnhelpfulCount
                                    </button>
                                }
                                else
                                {
                                    <span class="text-muted small">
                                        <i class="fas fa-thumbs-up text-success me-1"></i>@review.HelpfulCount
                                        <i class="fas fa-thumbs-down text-secondary ms-3 me-1"></i>@review.UnhelpfulCount
                                    </span>
                                }
                            </div>

                            <!-- æ“ä½œæŒ‰éˆ• -->
                            @if (User.Identity?.IsAuthenticated == true)
                            {
                                var userId = int.Parse(User.Claims.First(c => c.Type == "UserId").Value);
                                var userRole = User.Claims.FirstOrDefault(c => c.Type == "UserRole")?.Value ?? "";
                                
                                <div class="action-buttons">
                                    @* æª¢èˆ‰æŒ‰éˆ• *@
                                    @if (review.UserId != userId)
                                    {
                                        <button class="btn btn-sm btn-outline-warning me-1 report-review" 
                                                data-review-id="@review.Id" title="æª¢èˆ‰">
                                            <i class="fas fa-flag"></i>
                                        </button>
                                    }
                                    
                                    @* ç·¨è¼¯/åˆªé™¤æŒ‰éˆ• *@
                                    @if (review.UserId == userId || userRole == "Admin" || userRole == "Engineer")
                                    {
                                        @if (review.UserId == userId)
                                        {
                                            <button class="btn btn-sm btn-outline-primary me-1 edit-review" 
                                                    data-review-id="@review.Id"
                                                    data-content="@review.Content"
                                                    data-rating="@review.Rating" title="ç·¨è¼¯">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        }
                                        
                                        <button class="btn btn-sm btn-outline-danger delete-review" 
                                                data-review-id="@review.Id" title="åˆªé™¤">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    }
                                    
                                    @* ç®¡ç†å“¡å°ˆç”¨æŒ‰éˆ• *@
                                    @if (userRole == "Admin" || userRole == "Engineer")
                                    {
                                        @if (!review.HasAdminReply)
                                        {
                                            <button class="btn btn-sm btn-outline-info ms-1 admin-reply" 
                                                    data-review-id="@review.Id" title="å›è¦†">
                                                <i class="fas fa-reply"></i>
                                            </button>
                                        }
                                        
                                        <button class="btn btn-sm @(review.IsPinned ? "btn-warning" : "btn-outline-warning") ms-1 toggle-pin" 
                                                data-review-id="@review.Id" title="@(review.IsPinned ? "å–æ¶ˆç½®é ‚" : "ç½®é ‚")">
                                            <i class="fas fa-thumbtack"></i>
                                        </button>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12">
                <div class="alert alert-info text-center py-5">
                    <div class="mb-3">
                        <i class="fas fa-comments" style="font-size: 3rem; color: #0dcaf0;"></i>
                    </div>
                    <h5>ğŸ“­ ç›®å‰æ²’æœ‰è©•åƒ¹</h5>
                    <p class="mb-3">
                        @if (ViewBag.ProductName != null)
                        {
                            <span>é‚„æ²’æœ‰äººè©•åƒ¹é€™å€‹å•†å“ï¼Œæˆç‚ºç¬¬ä¸€å€‹è©•åƒ¹çš„äººå§ï¼</span>
                        }
                        else
                        {
                            <span>ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è©•åƒ¹ï¼Œè©¦è©¦èª¿æ•´ç¯©é¸æ¢ä»¶ã€‚</span>
                        }
                    </p>
                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addReviewModal">
                            <i class="fas fa-star me-1"></i>å¯«ç¬¬ä¸€å€‹è©•åƒ¹
                        </button>
                    }
                    else
                    {
                        <a asp-controller="Account" asp-action="Login" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt me-1"></i>ç™»å…¥å¾Œè©•åƒ¹
                        </a>
                    }
                </div>
            </div>
        }
    </div>

    <!-- åˆ†é  -->
    @if (Model != null && Model.TotalPages > 1)
    {
        <nav aria-label="è©•åƒ¹åˆ†é " class="mt-4">
            <ul class="pagination justify-content-center">
                @if (Model.HasPreviousPage)
                {
                    <li class="page-item">
                        <a class="page-link" href="?page=@(Model.PageNumber - 1)&sort=@currentSort&keyword=@currentKeyword&scoreFilter=@currentScoreFilter@(productId != null ? $"&productId={productId}" : "")">
                            <i class="fas fa-chevron-left me-1"></i>ä¸Šä¸€é 
                        </a>
                    </li>
                }

                @{
                    var startPage = Math.Max(1, Model.PageNumber - 2);
                    var endPage = Math.Min(Model.TotalPages, Model.PageNumber + 2);
                }

                @for (var i = startPage; i <= endPage; i++)
                {
                    <li class="page-item @(Model.PageNumber == i ? "active" : "")">
                        <a class="page-link" href="?page=@i&sort=@currentSort&keyword=@currentKeyword&scoreFilter=@currentScoreFilter@(productId != null ? $"&productId={productId}" : "")">@i</a>
                    </li>
                }

                @if (Model.HasNextPage)
                {
                    <li class="page-item">
                        <a class="page-link" href="?page=@(Model.PageNumber + 1)&sort=@currentSort&keyword=@currentKeyword&scoreFilter=@currentScoreFilter@(productId != null ? $"&productId={productId}" : "")">
                            ä¸‹ä¸€é <i class="fas fa-chevron-right ms-1"></i>
                        </a>
                    </li>
                }
            </ul>
        </nav>
    }
</div>

<!-- æ–°å¢è©•åƒ¹æ¨¡æ…‹æ¡† -->
@if (User.Identity?.IsAuthenticated == true)
{
    <div class="modal fade" id="addReviewModal" tabindex="-1" aria-labelledby="addReviewModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="addReviewModalLabel">
                        <i class="fas fa-star me-2"></i>æ–°å¢è©•åƒ¹
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addReviewForm" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">è©•åˆ†ï¼š</label>
                            <select name="rating" class="form-select" required>
                                <option value="">è«‹é¸æ“‡è©•åˆ†</option>
                                <option value="5">â­â­â­â­â­ éå¸¸æ»¿æ„</option>
                                <option value="4">â­â­â­â­â˜† æ»¿æ„</option>
                                <option value="3">â­â­â­â˜†â˜† æ™®é€š</option>
                                <option value="2">â­â­â˜†â˜†â˜† ä¸æ»¿æ„</option>
                                <option value="1">â­â˜†â˜†â˜†â˜† éå¸¸ä¸æ»¿æ„</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">è©•åƒ¹å…§å®¹ï¼š</label>
                            <textarea name="content" class="form-control" rows="4" 
                                      placeholder="è«‹è©³ç´°æè¿°æ‚¨çš„ä½¿ç”¨é«”é©—ï¼Œå¹«åŠ©å…¶ä»–è²·å®¶åšå‡ºæ›´å¥½çš„é¸æ“‡..." 
                                      required minlength="10" maxlength="1000"></textarea>
                            <div class="form-text">è«‹è‡³å°‘è¼¸å…¥10å€‹å­—ï¼Œæœ€å¤š1000å­—</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">å•†å“IDï¼š</label>
                            <input type="number" name="productId" class="form-control" value="@(productId ?? 1)" required />
                            <div class="form-text">è«‹ç¢ºèªå•†å“IDæ­£ç¢º</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">ä¸Šå‚³åœ–ç‰‡ï¼ˆé¸å¡«ï¼‰ï¼š</label>
                            <input type="file" name="imageFile" class="form-control" accept="image/*" />
                            <div class="form-text">æ”¯æ´ JPGã€PNGã€GIF æ ¼å¼ï¼Œæª”æ¡ˆå¤§å°ä¸è¶…é 5MB</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>å–æ¶ˆ
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-paper-plane me-1"></i>æäº¤è©•åƒ¹
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<!-- åœ–ç‰‡æª¢è¦–æ¨¡æ…‹æ¡† -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">è©•åƒ¹åœ–ç‰‡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid" alt="è©•åƒ¹åœ–ç‰‡" />
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // è‡ªå‹•æäº¤è¡¨å–®ç•¶é¸é …æ”¹è®Š
            $('select[name="scoreFilter"], select[name="sort"]').change(function() {
                $(this).closest('form').submit();
            });

            // æ–°å¢è©•åƒ¹
            $('#addReviewForm').submit(function(e) {
                e.preventDefault();

                const formData = new FormData(this);
                const submitBtn = $(this).find('button[type="submit"]');
                const originalText = submitBtn.html();

                // è¡¨å–®é©—è­‰
                const content = $('textarea[name="content"]').val().trim();
                if (content.length < 10) {
                    alert('è©•åƒ¹å…§å®¹è‡³å°‘éœ€è¦10å€‹å­—');
                    return;
                }

                submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>æäº¤ä¸­...');

                $.ajax({
                    url: '@Url.Action("Create", "Review")',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(result) {
                        if (result.success) {
                            $('#addReviewModal').modal('hide');
                            alert('âœ… ' + (result.message || 'è©•åƒ¹æ–°å¢æˆåŠŸï¼æ„Ÿè¬æ‚¨çš„å›é¥‹'));
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            alert('âŒ ' + (result.message || 'æäº¤å¤±æ•—'));
                        }
                    },
                    error: function(xhr) {
                        console.error('æäº¤éŒ¯èª¤:', xhr);
                        alert('âŒ æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
                    },
                    complete: function() {
                        submitBtn.prop('disabled', false).html(originalText);
                    }
                });
            });

            // æœ‰ç”¨æ€§æŠ•ç¥¨
            $(document).on('click', '.vote-helpful', function() {
                const reviewId = $(this).data('review-id');
                const isHelpful = $(this).data('helpful');
                
                $.ajax({
                    url: '@Url.Action("VoteHelpful", "Review")',
                    type: 'POST',
                    data: { reviewId: reviewId, isHelpful: isHelpful },
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(result) {
                        if (result.success) {
                            // æ›´æ–°æŠ•ç¥¨æ•¸
                            const card = $(`.vote-helpful[data-review-id="${reviewId}"]`).closest('.card');
                            card.find('.vote-helpful[data-helpful="true"]').html(`<i class="fas fa-thumbs-up me-1"></i>${result.helpfulCount}`);
                            card.find('.vote-helpful[data-helpful="false"]').html(`<i class="fas fa-thumbs-down me-1"></i>${result.unhelpfulCount}`);
                            
                            alert(isHelpful ? 'âœ… æ„Ÿè¬æ‚¨çš„åé¥‹ï¼' : 'âœ… æ„Ÿè¬æ‚¨çš„åé¥‹ï¼');
                        } else {
                            alert('âŒ ' + (result.message || 'æ“ä½œå¤±æ•—'));
                        }
                    },
                    error: function() {
                        alert('âŒ æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
                    }
                });
            });

            // åˆªé™¤è©•åƒ¹
            $(document).on('click', '.delete-review', function() {
                if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è©•åƒ¹å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                    const reviewId = $(this).data('review-id');
                    
                    $.ajax({
                        url: '@Url.Action("Delete", "Review")',
                        type: 'POST',
                        data: { reviewId: reviewId },
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function(result) {
                            if (result.success) {
                                alert('âœ… ' + (result.message || 'è©•åƒ¹å·²åˆªé™¤'));
                                location.reload();
                            } else {
                                alert('âŒ ' + (result.message || 'åˆªé™¤å¤±æ•—'));
                            }
                        },
                        error: function() {
                            alert('âŒ åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
                        }
                    });
                }
            });
        });

        // é¡¯ç¤ºåœ–ç‰‡æ¨¡æ…‹æ¡†
        function showImageModal(imageSrc) {
            $('#modalImage').attr('src', imageSrc);
            $('#imageModal').modal('show');
        }
    </script>

    <style>
        .review-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .review-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .admin-reply {
            border-left: 4px solid #0dcaf0;
        }

        .helpful-votes .btn {
            font-size: 0.875rem;
        }

        .action-buttons .btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
    </style>
}